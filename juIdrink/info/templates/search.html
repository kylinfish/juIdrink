{% extends 'base.html' %} 
{% block content %}
{% load staticfiles %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<div id="map-canvas" style="margin-top:130px;position: absolute; left: 10%; top: 0px; z-index: 2; width: 80%; height: 45%;"></div>


<div class="container" >
  <div class="row">
    <div class="col-md-12 custyle">
        <table class="table table-striped custab">
          <thead>
            <tr>
              <th>商家</th>
              <th>分店</th>
              <th>地址</th>
              <th>電話</th>
              <th>座標</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>


<style>
  .custyle{
    margin-top:600px; 
    padding-bottom:20px;
  }
  .ma{
     margin-top:110px; 
  
  }
</style>

<script>
var x = document.getElementById("demo");
var map;
var center = new google.maps.LatLng(25, 121);
var nearbyPoint = new Array(new google.maps.LatLng);
var userLocation =[];
$(function(){
 getLocation();

});


function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition,showError);
    } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

function showPosition(position) {
  var geo = [position.coords.latitude, position.coords.longitude];
  console.log(geo.toString());
  $.ajax({
    url: "http://maps.googleapis.com/maps/api/geocode/json" , 
    type: 'GET',
    async: 'false',
    data: {
      'latlng': position.coords.latitude+","+ position.coords.longitude,
      'sensor': "true_or_false",
    },success: function(msg) {
      for (var i =0 ;i <msg['results'][0]['address_components'].length ; i++){
        if (msg['results'][0]['address_components'][i]['types']=="postal_code"){
          center =  new google.maps.LatLng(25.0596516, 121.532691);
          doSearch(msg['results'][0]['address_components'][i]['long_name'],msg['results'][0]['formatted_address'])
        }
      }
      initialize();
    },error: function(msg) {
      console.log('錯誤記錄');
    }
  });
}

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            x.innerHTML = "User denied the request for Geolocation."
            break;
        case error.POSITION_UNAVAILABLE:
            x.innerHTML = "Location information is unavailable."
            break;
        case error.TIMEOUT:
            x.innerHTML = "The request to get user location timed out."
            break;
        case error.UNKNOWN_ERROR:
            x.innerHTML = "An unknown error occurred."
            break;
    }
}

function doSearch(zipcode,address){
    $.ajax({
      url: "/locate" , 
      type: 'POST',
      data: {
        'zipcode': zipcode,

      },success: function(msg) {
        msg = JSON.parse(msg['data']);
        for (var i=0;i<msg.length;i++){
          var content = "<tr><td>"+msg[i]['fields']['store']+"</td><td>"+msg[i]['fields']['store_name']+"</td><td>"+msg[i]['fields']['address']+"</td><td>"+msg[i]['fields']['phone']+"</td><td>"+msg[i]['fields']['location']+"</td><td>";
          $("#tbody").append(content);
          var s  =msg[i]['fields']['location'].split(',');
          var lat=parseFloat(s[0]);
          var lng=parseFloat(s[1]);
          neighborhoods.push(new google.maps.LatLng(lat, lng));
        }
        console.log("location end");
        console.log(neighborhoods[3])
        drop();
      },error: function(msg) {
        console.log('錯誤記錄');
      }
    });
    console.log(nearbyPoint);

}
// multimaker



console.log('center');
console.log(center);
var neighborhoods = [];

var markers = [];
var iterator = 0;

var map;

function initialize() {
  var mapOptions = {
    zoom: 15,
    center: center
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
          mapOptions);
}

function drop() {
   markers.push(new google.maps.Marker({
    position: center,
    map: map,
    icon:"http://italc.sourceforge.net/home.png"
  }));
  for (var i = 0; i < neighborhoods.length; i++) {
    setTimeout(function() {
      addMarker();
    }, i * 200);
  }
  console.log("dropend");
}

function addMarker() {
  markers.push(new google.maps.Marker({
    position: neighborhoods[iterator],
    map: map,
    draggable: false,
    animation: google.maps.Animation.DROP
  }));
  iterator++;
}


</script>
{% endblock %}